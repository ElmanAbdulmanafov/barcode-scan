<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <style>
    body{font-family:Arial;margin:16px}
    video{width:100%;border-radius:14px;background:#000}
    input,button{font-size:18px;padding:12px;width:100%;margin:8px 0;box-sizing:border-box}
    .small{font-size:13px;opacity:.95}
    .ok{color:#0a7}.err{color:#c00}
    .box{padding:12px;border:1px solid #ddd;border-radius:14px}
    pre{white-space:pre-wrap;word-break:break-word}
    .row{display:flex;gap:10px}
    .row button{width:50%}
    label{display:block;margin-top:8px}
    input[type="range"]{width:100%}
  </style>
</head>
<body>
  <h2>1D Barcode Scanner</h2>

  <div class="box">
    <label class="small">Operator</label>
    <input id="operator" placeholder="mÉ™s: Guard-1 / Elman" />
    <div class="small">Operator cihazda yadda qalacaq.</div>
  </div>

  <div class="box" style="margin-top:12px;">
    <video id="video" playsinline></video>
    <div id="status" class="small"></div>

    <div class="row">
      <button id="btnTorch" disabled>ðŸ”¦ Torch ON/OFF</button>
      <button id="btnRefocus" disabled>ðŸŽ¯ Refocus</button>
    </div>

    <label class="small">Zoom</label>
    <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" disabled />

    <pre id="debug" class="small"></pre>
  </div>

  <button id="btnStart">Scan baÅŸla</button>
  <button id="btnStop" style="display:none;">Stop</button>

<script>
  // ====== 1) SÆNÄ°N APPS SCRIPT URL ======
  const APPS_SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbwP1w4cSWeKOZKMUvVyQA7dCjI-XRK9xSCULMkr0gGZYCkoyQjst0Eas6yzqhkOaBSpjQ/exec";

  // ====== UI ======
  const operatorEl = document.getElementById("operator");
  const videoEl = document.getElementById("video");
  const statusEl = document.getElementById("status");
  const debugEl  = document.getElementById("debug");
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnTorch = document.getElementById("btnTorch");
  const btnRefocus = document.getElementById("btnRefocus");
  const zoomEl   = document.getElementById("zoom");

  function setStatus(msg, cls="") {
    statusEl.className = "small " + cls;
    statusEl.textContent = msg;
  }
  function dbg(msg) {
    debugEl.textContent = msg + "\n" + debugEl.textContent;
    console.log(msg);
  }

  // operator yadda saxla
  operatorEl.value = localStorage.getItem("operator") || "";
  operatorEl.addEventListener("input", ()=> localStorage.setItem("operator", operatorEl.value));

  // ====== 2) ZXing UMD yÃ¼klÉ™mÉ™ (jsDelivr -> unpkg) ======
  function loadScript(url) {
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Script load failed: " + url));
      document.head.appendChild(s);
    });
  }

  async function ensureZXingLoaded() {
    if (window.ZXing) return;

    const urls = [
      "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js",
      "https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"
    ];

    for (const u of urls) {
      try {
        dbg("ZXing yÃ¼klÉ™nir: " + u);
        await loadScript(u);
        if (window.ZXing) { dbg("ZXing OK âœ…"); return; }
      } catch (e) {
        dbg("ZXing FAIL âŒ " + e.message);
      }
    }
    throw new Error("ZXing yÃ¼klÉ™nmÉ™di (CDN blok ola bilÉ™r).");
  }

  // ====== 3) POST (urlencoded + TEXT response) ======
  async function postScan(barcode, operator) {
    const body = new URLSearchParams({ barcode, operator });

    const res = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
      },
      body
    });

    const text = await res.text(); // âœ… JSON YOX!
    dbg("POST RESP (" + res.status + "): " + text);

    if (!res.ok) throw new Error("HTTP " + res.status + ": " + text);
    if (!text.trim().startsWith("OK")) throw new Error(text || "POST error");
  }

  // ====== 4) Kamera + Torch/Zoom ======
  let stream = null;
  let track = null;
  let torchOn = false;

  async function openCameraStrong() {
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false,
      video:{
        facingMode:{ ideal:"environment" },
        width:{ ideal: 1920 },
        height:{ ideal: 1080 }
      }
    });

    videoEl.srcObject = stream;
    await videoEl.play();

    track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities ? track.getCapabilities() : {};

    dbg("Caps: " + JSON.stringify({
      torch: !!caps.torch,
      zoom: caps.zoom ? {min:caps.zoom.min, max:caps.zoom.max} : null,
      focusMode: caps.focusMode || null
    }));

    // torch
    btnTorch.disabled = !caps.torch;

    // zoom
    if (caps.zoom) {
      zoomEl.disabled = false;
      zoomEl.min = caps.zoom.min;
      zoomEl.max = caps.zoom.max;
      zoomEl.step = 0.1;
      zoomEl.value = Math.min(Math.max(2.0, zoomEl.min), zoomEl.max); // default 2x
      await setZoom(zoomEl.value);
    } else {
      zoomEl.disabled = true;
    }

    // refocus
    btnRefocus.disabled = !(caps.focusMode && caps.focusMode.length);
  }

  async function setTorch(on) {
    if (!track?.applyConstraints) return;
    try {
      await track.applyConstraints({ advanced: [{ torch: on }] });
      torchOn = on;
      dbg("Torch: " + (on ? "ON" : "OFF"));
    } catch(e) {
      dbg("Torch error: " + (e.message || e));
    }
  }

  async function setZoom(val) {
    if (!track?.applyConstraints) return;
    try {
      await track.applyConstraints({ advanced: [{ zoom: Number(val) }] });
      dbg("Zoom set: " + val);
    } catch(e) {
      dbg("Zoom error: " + (e.message || e));
    }
  }

  async function refocus() {
    if (!track?.applyConstraints) return;
    try {
      await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
      dbg("Refocus: continuous");
    } catch(e) {
      dbg("Refocus error: " + (e.message || e));
    }
  }

  btnTorch.onclick = async () => { await setTorch(!torchOn); };
  zoomEl.oninput = async () => { await setZoom(zoomEl.value); };
  btnRefocus.onclick = async () => { await refocus(); };

  // ====== 5) Scan (ZXing) ======
  let reader = null;
  let scanning = false;
  let last = "", lastAt = 0;

  function stopAll() {
    scanning = false;

    try { if (reader) reader.reset(); } catch {}
    reader = null;

    try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch {}
    stream = null;
    track = null;
    videoEl.srcObject = null;

    btnTorch.disabled = true;
    btnRefocus.disabled = true;
    zoomEl.disabled = true;
  }

  btnStart.onclick = async () => {
    debugEl.textContent = "";

    const operator = operatorEl.value.trim();
    if (!operator) {
      setStatus("Operatoru yaz (mÉ™s: Guard-1).", "err");
      operatorEl.focus();
      return;
    }

    btnStart.disabled = true;
    btnStop.style.display = "block";
    setStatus("HazÄ±rlanÄ±r...", "");

    try {
      await ensureZXingLoaded();
      await openCameraStrong();
      setStatus("Scan aktivdir. Barkodu 20-30 sm tut.", "ok");

      // SÉ™ndÉ™ki barkodda *...* var â†’ CODE_39 mÃ¼tlÉ™q É™lavÉ™dir
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.CODE_39,
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.CODE_93,
        ZXing.BarcodeFormat.ITF,
        ZXing.BarcodeFormat.CODABAR,
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8,
        ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.UPC_E
      ]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

      reader = new ZXing.BrowserMultiFormatReader(hints);

      scanning = true;

      await reader.decodeFromConstraints(
        { video:{ facingMode:{ ideal:"environment" } }, audio:false },
        videoEl,
        async (result, err) => {
          if (!scanning) return;

          if (result) {
            const code = String(result.getText ? result.getText() : result.text || "").trim();
            if (!code) return;

            dbg("READ âœ… " + code);

            const now = Date.now();
            if (code === last && (now - lastAt) < 1500) return;
            last = code; lastAt = now;

            if (navigator.vibrate) navigator.vibrate(80);

            setStatus(`Oxundu: ${code} â†’ gÃ¶ndÉ™rilir...`, "");
            try {
              await postScan(code, operatorEl.value.trim());
              setStatus(`YazÄ±ldÄ± âœ… ${code}`, "ok");
            } catch (e) {
              setStatus("POST XÉ™ta âŒ " + (e.message || e), "err");
              dbg("POST XÆTASI: " + (e.message || e));
            }
          }
        }
      );

    } catch (e) {
      setStatus("XÉ™ta âŒ " + (e.message || e), "err");
      dbg("START XÆTASI: " + (e.message || e));
      stopAll();
      btnStart.disabled = false;
      btnStop.style.display = "none";
    }
  };

  btnStop.onclick = () => {
    stopAll();
    btnStart.disabled = false;
    btnStop.style.display = "none";
    setStatus("DayandÄ±rÄ±ldÄ±.", "");
    dbg("Stop edildi.");
  };

  setStatus("Operator yaz â†’ 'Scan baÅŸla'. Sonra ðŸ”¦ vÉ™ Zoom istifadÉ™ et.", "");
</script>
</body>
</html>
