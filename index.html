<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <style>
    body{font-family:Arial;margin:16px}
    video{width:100%;border-radius:14px;background:#000}
    input,button{font-size:18px;padding:12px;width:100%;margin:8px 0;box-sizing:border-box}
    .small{font-size:13px;opacity:.95}
    .ok{color:#0a7}.err{color:#c00}
    .box{padding:12px;border:1px solid #ddd;border-radius:14px}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <h2>1D Barcode Scanner</h2>

  <div class="box">
    <label class="small">Operator</label>
    <input id="operator" placeholder="məs: Guard-1 / Elman" />
    <div class="small">Operator cihazda yadda qalacaq.</div>
  </div>

  <div class="box" style="margin-top:12px;">
    <video id="video" playsinline></video>
    <div id="status" class="small"></div>
    <pre id="debug" class="small"></pre>
  </div>

  <button id="btnPerm">1) Kamera icazəsi ver</button>
  <button id="btnStart">2) Scan başla</button>
  <button id="btnStop" style="display:none;">Stop</button>

<script>
  // ✅ Apps Script URL-in
  const APPS_SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbwP1w4cSWeKOZKMUvVyQA7dCjI-XRK9xSCULMkr0gGZYCkoyQjst0Eas6yzqhkOaBSpjQ/exec";

  const operatorEl = document.getElementById("operator");
  const videoEl = document.getElementById("video");
  const statusEl = document.getElementById("status");
  const debugEl  = document.getElementById("debug");
  const btnPerm  = document.getElementById("btnPerm");
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");

  function setStatus(msg, cls="") {
    statusEl.className = "small " + cls;
    statusEl.textContent = msg;
  }
  function dbg(msg) {
    debugEl.textContent = msg + "\n" + debugEl.textContent;
    console.log(msg);
  }

  // Operatoru yadda saxla
  operatorEl.value = localStorage.getItem("operator") || "";
  operatorEl.addEventListener("input", ()=> localStorage.setItem("operator", operatorEl.value));

  // ========== 1) Kamera permission testi (ZXing-dən asılı deyil) ==========
  async function requestCameraPermission() {
    if (!navigator.mediaDevices?.getUserMedia) {
      throw new Error("Bu brauzer kamera API-ni dəstəkləmir. Chrome/Safari istifadə et.");
    }
    const s = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    s.getTracks().forEach(t => t.stop());
  }

  btnPerm.onclick = async () => {
    debugEl.textContent = "";
    setStatus("Kamera icazəsi soruşulur...", "");
    try {
      await requestCameraPermission();
      setStatus("İcazə verildi ✅ İndi 'Scan başla' bas.", "ok");
      dbg("Permission OK ✅");
    } catch (e) {
      const name = e?.name ? (e.name + " - ") : "";
      setStatus("Kamera icazəsi alınmadı ❌", "err");
      dbg("KAMERA XƏTASI: " + name + (e.message || e));
      dbg("İpucu: Linki Telegram/WhatsApp içindən yox, mütləq Chrome/Safari-də aç (Open in browser).");
      dbg("İpucu: Chrome/Safari site settings → Camera → Allow.");
      dbg("İpucu: Kamera başqa app tərəfindən tutulubsa (Camera/Instagram), hamısını bağla.");
    }
  };

  // ========== 2) ZXing dinamik yükləmə (unpkg blokdursa jsDelivr) ==========
  function loadScript(url) {
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Script load failed: " + url));
      document.head.appendChild(s);
    });
  }

  async function ensureZXingLoaded() {
    if (window.ZXing) return;

    const urls = [
      // 1) jsDelivr (adətən daha çox açılır)
      "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js",
      // 2) unpkg fallback
      "https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"
    ];

    for (const u of urls) {
      try {
        dbg("ZXing yüklənir: " + u);
        await loadScript(u);
        if (window.ZXing) {
          dbg("ZXing OK ✅");
          return;
        }
      } catch (e) {
        dbg("ZXing FAIL ❌ " + e.message);
      }
    }
    throw new Error("ZXing yüklənmədi. Şəbəkə/CDN blok ola bilər (firewall).");
  }

  // ========== 3) Scan + POST ==========
  let scanning = false;
  let stream = null;
  let last = "", lastAt = 0;
  let codeReader = null;
  let controls = null;

  async function postScan(barcode, operator) {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ barcode, operator })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Xəta");
  }

  async function openStream() {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    videoEl.srcObject = stream;
    await videoEl.play();
  }

  btnStart.onclick = async () => {
    debugEl.textContent = "";

    const operator = operatorEl.value.trim();
    if (!operator) {
      setStatus("Operatoru yaz (məs: Guard-1).", "err");
      operatorEl.focus();
      return;
    }

    btnStart.disabled = true;
    setStatus("Hazırlanır...", "");

    try {
      // Kamera stream
      setStatus("Kamera açılır...", "");
      await openStream();
      dbg("Stream açıldı ✅");

      // ZXing yüklə
      setStatus("Scanner yüklənir...", "");
      await ensureZXingLoaded();

      // ZXing reader qur
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.CODE_39,
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8,
        ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.UPC_E,
        ZXing.BarcodeFormat.ITF
      ]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

      codeReader = new ZXing.BrowserMultiFormatContinuousReader(hints);

      scanning = true;
      btnStop.style.display = "block";
      setStatus("Scan aktivdir. Barkodu kameraya göstər.", "");

      // Continuous decode
      controls = await codeReader.decodeFromVideoElementContinuously(videoEl, async (result, err) => {
        if (!scanning) return;
        if (result) {
          const code = String(result.getText ? result.getText() : result.text || "").trim();
          if (!code) return;

          const now = Date.now();
          if (code === last && (now - lastAt) < 1500) return;
          last = code; lastAt = now;

          if (navigator.vibrate) navigator.vibrate(80);

          setStatus(`Oxundu: ${code} → göndərilir...`, "");
          try {
            await postScan(code, operatorEl.value.trim());
            setStatus(`Yazıldı ✅ ${code}`, "ok");
          } catch (e) {
            setStatus("POST Xəta ❌ " + (e.message || e), "err");
            dbg("POST XƏTASI: " + (e.message || e));
          }
        }
      });

    } catch (e) {
      const name = e?.name ? (e.name + " - ") : "";
      setStatus("Xəta ❌ " + name + (e.message || e), "err");
      dbg("START XƏTASI: " + name + (e.message || e));

      // təmizlə
      scanning = false;
      btnStop.style.display = "none";
      btnStart.disabled = false;

      try { if (controls?.stop) controls.stop(); } catch {}
      try { if (codeReader?.reset) codeReader.reset(); } catch {}
      try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch {}
      stream = null;
      videoEl.srcObject = null;
    }
  };

  btnStop.onclick = () => {
    scanning = false;

    try { if (controls?.stop) controls.stop(); } catch {}
    try { if (codeReader?.reset) codeReader.reset(); } catch {}

    try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch {}
    stream = null;
    videoEl.srcObject = null;

    btnStop.style.display = "none";
    btnStart.disabled = false;
    setStatus("Dayandırıldı.", "");
    dbg("Stop edildi.");
  };

  setStatus("1) 'Kamera icazəsi ver' bas → sonra 2) 'Scan başla'", "");
</script>
</body>
</html>
