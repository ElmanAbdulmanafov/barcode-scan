<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <style>
    :root{
      --bg:#0b0f14; --card:#121822; --muted:#9fb0c3; --text:#e9f0f7;
      --ok:#19c37d; --err:#ff4d4f; --border:rgba(255,255,255,.08);
      --btn:#223149;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:520px;margin:0 auto;padding:14px}
    .title{font-size:20px;font-weight:800;margin:6px 0 6px}
    .sub{font-size:13px;color:var(--muted);margin:0 0 12px;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;margin:10px 0}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0e1420;color:var(--text);font-size:16px;outline:none}
    .row{display:flex;gap:10px;margin-top:10px}
    button{width:100%;border:1px solid var(--border);background:var(--btn);color:var(--text);padding:12px;font-size:16px;border-radius:12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    #viewport{width:100%;height:220px;border-radius:14px;overflow:hidden;border:1px solid var(--border);background:#000;display:none}
    #viewport video,#viewport canvas{width:100%!important;height:100%!important;object-fit:cover!important;display:block}
    .pill{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:#0e1420;font-size:13px;line-height:1.25}
    .pill.ok{display:block;border-color:rgba(25,195,125,.35);background:rgba(25,195,125,.12);color:#c8ffe6}
    .pill.err{display:block;border-color:rgba(255,77,79,.35);background:rgba(255,77,79,.10);color:#ffe3e3}
    .pill.info{display:block;color:var(--muted)}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--text)}
    details{margin-top:10px}
    pre{white-space:pre-wrap;word-break:break-word;font-size:12px;color:#c7d4e2;background:#0e1420;border:1px solid var(--border);padding:10px;border-radius:12px;margin:8px 0 0;max-height:160px;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">LOT Barcode Scan</div>
    <p class="sub">
      Yalnız <b>2026 / 2027 / 2028</b> ilə başlayan kodlar qəbul edilir.
      Saxta oxunuşların qarşısı üçün kod <b>3 dəfə ardıcıl eyni</b> gəlməlidir.
    </p>

    <div class="card">
      <label>Operator</label>
      <input id="operator" placeholder="məs: Guard-1 / Elman" autocomplete="off"/>

      <div class="row">
        <button id="btnStart">Scan başla</button>
        <button id="btnStop" style="display:none;background:rgba(255,77,79,.12)">Stop</button>
      </div>

      <div id="viewport"></div>

      <div id="status" class="pill info"></div>

      <details>
        <summary style="color:var(--muted);font-size:13px;">Debug</summary>
        <pre id="debug"></pre>
      </details>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
  <script>
    const APPS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbyMlTDXh-2DRVetIsrPm3KIh2_9J9sWOMntcLl1ADgKjfumlIj3cGaYI2i7ht4v2qHr7w/exec";

    const operatorEl = document.getElementById("operator");
    const viewportEl = document.getElementById("viewport");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const btnStart = document.getElementById("btnStart");
    const btnStop  = document.getElementById("btnStop");

    function dbg(msg){ debugEl.textContent = msg + "\n" + debugEl.textContent; console.log(msg); }

    function status(type, html){
      statusEl.className = "pill " + (type || "info");
      statusEl.innerHTML = html;
    }

    operatorEl.value = localStorage.getItem("operator") || "";
    operatorEl.addEventListener("input", ()=> localStorage.setItem("operator", operatorEl.value));

    // --- FILTER: yalnız 2026/2027/2028 və yalnız rəqəm
    function isAllowed(code){
      if (!/^\d+$/.test(code)) return false;
      return code.startsWith("2026") || code.startsWith("2027") || code.startsWith("2028");
    }

    // --- POST
    async function postScan(barcode, operator){
      const body = new URLSearchParams({ barcode, operator });
      const res = await fetch(APPS_SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body
      });
      const text = await res.text();
      dbg("POST ("+res.status+"): " + text.slice(0,200));
      if (!res.ok) throw new Error("HTTP "+res.status+": "+text);

      // JSON ola bilər, text ola bilər
      try{
        const data = JSON.parse(text);
        if (data && data.ok === false) throw new Error(data.error || "Server error");
      }catch{
        if (!text.trim().toUpperCase().startsWith("OK") && !text.includes('"ok":true'))
          throw new Error("Server response: "+text);
      }
    }

    // --- anti-false-positive parametrlər
    const REQUIRED_SAME_HITS = 3;      // 3 dəfə ardıcıl eyni kod
    const MAX_AVG_ERROR = 0.20;        // decodedCodes error ortalaması (0-1). aşağı daha yaxşı.
    const MIN_DECODED_PARTS = 4;       // nə qədər çox decodedCodes olarsa, o qədər etibarlı (praktik filter)

    let running = false;
    let lastAccepted = "";
    let hitMap = new Map(); // code -> consecutive hits
    let lastSeenCode = "";

    function resetHits(){
      hitMap.clear();
      lastSeenCode = "";
    }

    function stopScanner(){
      running = false;
      try{ Quagga.stop(); }catch{}
      viewportEl.style.display = "none";
      btnStart.disabled = false;
      btnStop.style.display = "none";
    }

    btnStop.onclick = () => {
      stopScanner();
      status("info", "Dayandırıldı.");
      resetHits();
    };

    btnStart.onclick = () => {
      const operator = operatorEl.value.trim();
      if (!operator){
        status("err", "❌ Operatoru yaz (məs: Guard-1).");
        operatorEl.focus();
        return;
      }

      debugEl.textContent = "";
      resetHits();

      btnStart.disabled = true;
      btnStop.style.display = "block";
      viewportEl.style.display = "block";
      status("info", "Kamera açılır... Barkodu mərkəzdə saxla.");

      Quagga.init({
        inputStream: {
          type:"LiveStream",
          target: viewportEl,
          constraints:{
            facingMode:"environment",
            width:{ ideal: 1280 },
            height:{ ideal: 720 }
          },
          // Mərkəz zonası: kənarı oxuma, false positive azalır
          area:{ top:"33%", right:"12%", left:"12%", bottom:"33%" }
        },
        locator:{ patchSize:"large", halfSample:false },
        locate:true,
        numOfWorkers:2,
        frequency:10,
        decoder:{
          // ⛔ EAN/UPC-ni bağlayırıq: false positive çox verir
          // ✅ CODE39 + CODE128: LOT tipinə daha uyğun
          readers:[
            "code_39_reader",
            "code_128_reader",
            "code_93_reader",
            "i2of5_reader"
          ]
        }
      }, (err) => {
        if (err){
          dbg("INIT ERROR: " + err);
          status("err", "❌ Kamera/scanner açılmadı: " + err);
          btnStart.disabled = false;
          btnStop.style.display = "none";
          viewportEl.style.display = "none";
          return;
        }
        Quagga.start();
        running = true;
        status("info", "Scan aktivdir ✅ Barkodu mərkəzdə saxla (20–30 sm).");
        dbg("Started ✅");
      });

      Quagga.onDetected(async (data) => {
        if (!running) return;

        const code = data?.codeResult?.code ? String(data.codeResult.code).trim() : "";
        if (!code) return;

        // 1) prefix filter
        if (!isAllowed(code)) { dbg("SKIP prefix: " + code); return; }

        // 2) quality filter (error)
        const parts = data?.codeResult?.decodedCodes || [];
        const errors = parts
          .map(p => (typeof p.error === "number" ? p.error : null))
          .filter(v => v !== null);

        // bəzi cihazlarda decodedCodes boş ola bilər, onda bu filteri çox sərt etməyək
        if (errors.length >= MIN_DECODED_PARTS){
          const avgErr = errors.reduce((a,b)=>a+b,0) / errors.length;
          if (avgErr > MAX_AVG_ERROR) {
            dbg("SKIP quality avgErr=" + avgErr.toFixed(3) + " code=" + code);
            return;
          }
        }

        // 3) consecutive hit logic (3 dəfə ardıcıl eyni)
        if (code !== lastSeenCode){
          // yeni kod gəldi: sayğacı yenilə
          lastSeenCode = code;
          hitMap.set(code, 1);
          status("info", "Tapıldı, təsdiqlənir... <span class='code'>" + code + "</span> (1/" + REQUIRED_SAME_HITS + ")");
          return;
        } else {
          const n = (hitMap.get(code) || 0) + 1;
          hitMap.set(code, n);
          status("info", "Tapıldı, təsdiqlənir... <span class='code'>" + code + "</span> (" + n + "/" + REQUIRED_SAME_HITS + ")");
          if (n < REQUIRED_SAME_HITS) return;
        }

        // 4) dalbadal eyni barkodu yazma
        if (code === lastAccepted){
          dbg("SKIP lastAccepted: " + code);
          return;
        }

        // qəbul
        lastAccepted = code;
        dbg("ACCEPT ✅ " + code);

        if (navigator.vibrate) navigator.vibrate(80);

        // kamera bağlanır, user rahat görsün
        stopScanner();
        status("ok", "✅ Oxundu: <span class='code'>" + code + "</span><br><span style='color:#9fb0c3'>Göndərilir...</span>");

        try{
          await postScan(code, operatorEl.value.trim());
          status("ok", "✅ Oxundu və yazıldı: <span class='code'>" + code + "</span>");
        }catch(e){
          status("err", "❌ Yazılmadı: " + (e.message || e));
          dbg("POST ERROR: " + (e.message || e));
        }
      });
    };

    status("info", "Operator yaz → Scan başla.");
  </script>
</body>
</html>
