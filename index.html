<!doctype html>
<html lang="az">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Terminal Scan</title>

<style>
body{margin:0;font-family:system-ui;background:#0b0f14;color:#e9f0f7}
.wrap{max-width:520px;margin:auto;padding:14px}
.card{background:#121822;border-radius:16px;padding:16px}
h3{margin-top:0}
input,button{
  width:100%;padding:12px;margin-top:10px;
  font-size:16px;border-radius:12px;border:none
}
input{background:#0e1420;color:#fff}
button{background:#223149;color:#fff;cursor:pointer}

#status{margin-top:12px;padding:10px;border-radius:12px}
.ok{background:#173b2f;color:#6dffb2}
.err{background:#3b1717;color:#ffb3b3}

#modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:999
}
#modalBox{
  background:#121822;padding:22px;border-radius:16px;
  text-align:center;font-size:18px;min-width:260px
}
#modalBox.ok{border:2px solid #19c37d}
#modalBox.err{border:2px solid #ff4d4f}

.code{font-family:monospace;font-size:16px}
.small{font-size:12px;color:#9fb0c3;margin-top:8px}
</style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h3>Terminal Barkod Scan</h3>

    <input id="operator" placeholder="Operator adƒ±">
    <input id="scan" placeholder="Kursor burada qalsƒ±n, barkodu scan et" autofocus>

    <div id="status">Hazƒ±rdƒ±r.</div>

    <div class="small">
      üìå Terminal skaneri barkodu klaviatura kimi yazƒ±r.  
      Suffix: <b>ENTER</b> v…ô ya <b>TAB</b> t√∂vsiy…ô olunur.
    </div>
  </div>
</div>

<div id="modal">
  <div id="modalBox"></div>
</div>

<script>
/* ===============================
   POWER AUTOMATE ENDPOINT
   =============================== */
const ENDPOINT_URL =
"https://defaultc660a74ec1ac4c5881cbe2654148fc.b7.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2c9603cebe1647dba66b07e8b44a5df1/triggers/manual/paths/invoke?api-version=1";

/* ===============================
   ELEMENTS
   =============================== */
const scanEl = document.getElementById("scan");
const operatorEl = document.getElementById("operator");
const statusEl = document.getElementById("status");
const modal = document.getElementById("modal");
const modalBox = document.getElementById("modalBox");

/* ===============================
   OPERATOR ‚Äì LOCAL STORAGE
   =============================== */
operatorEl.value = localStorage.getItem("operator") || "";
operatorEl.oninput = () =>
  localStorage.setItem("operator", operatorEl.value);

/* ===============================
   DUPLICATE BLOCK (SESSION)
   =============================== */
const scannedSet = new Set();

/* ===============================
   HELPERS
   =============================== */
function isAllowed(code){
  return /^\d+$/.test(code) &&
    (code.startsWith("2026") ||
     code.startsWith("2027") ||
     code.startsWith("2028"));
}

function showStatus(type, text){
  statusEl.className = type || "";
  statusEl.innerHTML = text;
}

function showModal(type, html){
  modalBox.className = type;
  modalBox.innerHTML = html;
  modal.style.display = "flex";
  setTimeout(()=> modal.style.display="none", 1500);
}

/* ===============================
   SEND TO POWER AUTOMATE
   =============================== */
async function sendToFlow(code){
  const payload = {
    barcode: code,
    operator: operatorEl.value,
    device: "Terminal-01"
  };

  const res = await fetch(ENDPOINT_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    throw new Error("HTTP " + res.status);
  }
}

/* ===============================
   MAIN HANDLER
   =============================== */
async function handleScan(raw){
  const code = String(raw || "").trim();
  scanEl.value="";
  scanEl.focus();

  if(!code) return;

  if(!operatorEl.value.trim()){
    showStatus("err","‚ùå Operator bo≈üdur");
    return;
  }

  if(!isAllowed(code)){
    showStatus("err","‚ùå Yanlƒ±≈ü barkod");
    showModal("err","‚ùå Q…ôbul edilm…ôdi<br><span class='code'>"+code+"</span>");
    return;
  }

  if(scannedSet.has(code)){
    showStatus("err","‚ö†Ô∏è T…ôkrar barkod bloklandƒ±");
    showModal("err","‚ö†Ô∏è Bu barkod artƒ±q oxunub<br><span class='code'>"+code+"</span>");
    return;
  }

  try{
    await sendToFlow(code);
    scannedSet.add(code);

    showStatus("ok","‚úÖ Yazƒ±ldƒ±: "+code);
    showModal("ok","‚úÖ Uƒüurla yazƒ±ldƒ±<br><span class='code'>"+code+"</span>");
  }catch(e){
    showStatus("err","‚ùå G√∂nd…ôrilm…ôdi");
    showModal("err","‚ùå Server x…ôtasƒ±");
  }
}

/* ===============================
   KEYBOARD SCAN (ENTER / TAB)
   =============================== */
scanEl.addEventListener("keydown",e=>{
  if(e.key==="Enter" || e.key==="Tab"){
    e.preventDefault();
    handleScan(scanEl.value);
  }
});

/* ===============================
   FALLBACK (NO ENTER)
   =============================== */
let t=null;
scanEl.addEventListener("input",()=>{
  if(t) clearTimeout(t);
  t=setTimeout(()=>{
    if(scanEl.value.length>=8){
      handleScan(scanEl.value);
    }
  },200);
});

scanEl.focus();
</script>
</body>
</html>
