<!doctype html>
<html lang="az">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Terminal Scan</title>
<style>
body{font-family:system-ui;background:#0b0f14;color:#e9f0f7;margin:0}
.wrap{max-width:500px;margin:auto;padding:14px}
.card{background:#121822;border-radius:16px;padding:14px}
input,button{width:100%;padding:12px;margin-top:8px;font-size:16px;border-radius:12px;border:none}
input{background:#0e1420;color:#fff}
button{background:#223149;color:#fff}
#msg{margin-top:10px;padding:10px;border-radius:12px}
.ok{background:#173b2f;color:#6dffb2}
.err{background:#3b1717;color:#ffb3b3}
#modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:999
}
#modalBox{
  background:#121822;padding:20px;border-radius:16px;
  font-size:18px;text-align:center;min-width:260px
}
#modalBox.ok{border:2px solid #19c37d}
#modalBox.err{border:2px solid #ff4d4f}
.code{font-family:monospace;font-size:16px}
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h3>Terminal Barkod Scan</h3>

    <input id="operator" placeholder="Operator adı">
    <input id="scan" placeholder="Barkodu scan et" autofocus>

    <div id="msg">Hazırdır.</div>
  </div>
</div>

<div id="modal">
  <div id="modalBox"></div>
</div>

<script>
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbyMlTDXh-2DRVetIsrPm3KIh2_9J9sWOMntcLl1ADgKjfumlIj3cGaYI2i7ht4v2qHr7w/exec";

const scanEl = document.getElementById("scan");
const operatorEl = document.getElementById("operator");
const msgEl = document.getElementById("msg");
const modal = document.getElementById("modal");
const modalBox = document.getElementById("modalBox");

// -------------------------
// OPERATOR YADDAŞI
// -------------------------
operatorEl.value = localStorage.getItem("operator") || "";
operatorEl.oninput = () => localStorage.setItem("operator", operatorEl.value);

// -------------------------
// GÜNLÜK DEDUP (localStorage)
// -------------------------
const DEDUP_DAY_KEY = "dedup_day_v1";
const DEDUP_SET_KEY = "dedup_set_v1";

// Yerli tarix üzrə gün açarı (YYYY-MM-DD)
function todayKeyLocal(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

// Gün dəyişibsə set-i sıfırla
function loadDailySet(){
  const today = todayKeyLocal();
  const savedDay = localStorage.getItem(DEDUP_DAY_KEY);

  if(savedDay !== today){
    localStorage.setItem(DEDUP_DAY_KEY, today);
    localStorage.setItem(DEDUP_SET_KEY, "[]");
  }

  try{
    const arr = JSON.parse(localStorage.getItem(DEDUP_SET_KEY) || "[]");
    return new Set(Array.isArray(arr) ? arr : []);
  }catch{
    localStorage.setItem(DEDUP_SET_KEY, "[]");
    return new Set();
  }
}

function saveDailySet(set){
  // çox yığılarsa browser limiti ola bilər; normalda gündəlik scan sayına yetir
  localStorage.setItem(DEDUP_SET_KEY, JSON.stringify(Array.from(set)));
}

// gündəlik yaddaş set-i
let scannedSet = loadDailySet();

// -------------------------
// QAYDALAR
// -------------------------
function isAllowed(code){
  return /^\d+$/.test(code) &&
    (code.startsWith("2026") || code.startsWith("2027") || code.startsWith("2028"));
}

function showModal(type, text){
  modalBox.className = type;
  modalBox.innerHTML = text;
  modal.style.display = "flex";
  setTimeout(()=> modal.style.display="none", 1500);
}

async function send(code){
  const body = new URLSearchParams({ barcode:code, operator:operatorEl.value });
  const r = await fetch(APPS_SCRIPT_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body
  });
  if(!r.ok) throw new Error("Server error");
}

async function handle(code){
  code = String(code || "").trim();

  scanEl.value = "";
  scanEl.focus();

  // Hər scan-da gün dəyişimini yoxla (gecə yarısı keçidi üçün)
  const curDay = todayKeyLocal();
  if(localStorage.getItem(DEDUP_DAY_KEY) !== curDay){
    scannedSet = loadDailySet();
  }

  if(!isAllowed(code)){
    msgEl.className="err";
    msgEl.innerHTML="Yanlış barkod";
    return;
  }

  if(scannedSet.has(code)){
    msgEl.className="err";
    msgEl.innerHTML="Təkrar barkod bloklandı (bu gün)";
    showModal("err","❌ Bu barkod bu gün artıq oxunub<br><span class='code'>"+code+"</span>");
    return;
  }

  if(!operatorEl.value.trim()){
    msgEl.className="err";
    msgEl.innerHTML="Operator boşdur";
    return;
  }

  try{
    await send(code);

    // ✅ Uğurlu yazıldıqdan sonra günlük set-ə əlavə et və yadda saxla
    scannedSet.add(code);
    saveDailySet(scannedSet);

    msgEl.className="ok";
    msgEl.innerHTML="Yazıldı: "+code;
    showModal("ok","✅ Uğurla yazıldı<br><span class='code'>"+code+"</span>");
  }catch(e){
    msgEl.className="err";
    msgEl.innerHTML="Göndərilmədi";
  }
}

scanEl.addEventListener("keydown",e=>{
  if(e.key==="Enter"||e.key==="Tab"){
    e.preventDefault();
    handle(scanEl.value.trim());
  }
});

let t=null;
scanEl.addEventListener("input",()=>{
  if(t) clearTimeout(t);
  t=setTimeout(()=>{
    if(scanEl.value.length>=8) handle(scanEl.value.trim());
  },200);
});

scanEl.focus();
</script>
</body>
</html>
