<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <style>
    body{font-family:Arial;margin:16px}
    .box{padding:12px;border:1px solid #ddd;border-radius:14px;margin:12px 0}
    input,button{font-size:18px;padding:12px;width:100%;margin:8px 0;box-sizing:border-box}
    .small{font-size:13px;opacity:.95}
    .ok{color:#0a7}.err{color:#c00}
    #viewport{position:relative;width:100%;border-radius:14px;overflow:hidden;background:#000}
    #viewport video, #viewport canvas{width:100% !important;height:auto !important;display:block}
    pre{white-space:pre-wrap;word-break:break-word}
    .row{display:flex;gap:10px}
    .row button{width:50%}
    label{display:block;margin-top:8px}
    input[type="range"]{width:100%}
  </style>
</head>
<body>

<h2>Strong 1D Barcode Scanner</h2>

<div class="box">
  <label class="small">Operator</label>
  <input id="operator" placeholder="m…ôs: Guard-1 / Elman" />
  <div class="small">Operator cihazda yadda qalacaq.</div>
</div>

<div class="box">
  <div id="viewport"></div>

  <div id="status" class="small"></div>

  <div class="row">
    <button id="btnStart">Scan ba≈üla</button>
    <button id="btnStop" style="display:none;">Stop</button>
  </div>

  <div class="row">
    <button id="btnTorch" disabled>üî¶ Torch</button>
    <button id="btnFocus" disabled>üéØ Refocus</button>
  </div>

  <label class="small">Zoom</label>
  <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" disabled />

  <pre id="debug" class="small"></pre>
</div>

<!-- Quagga2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

<script>
  // ====== APPS SCRIPT URL (S∆èNƒ∞N YENƒ∞ URL) ======
  const APPS_SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbyMlTDXh-2DRVetIsrPm3KIh2_9J9sWOMntcLl1ADgKjfumlIj3cGaYI2i7ht4v2qHr7w/exec";

  // ====== UI ======
  const operatorEl = document.getElementById("operator");
  const viewportEl = document.getElementById("viewport");
  const statusEl = document.getElementById("status");
  const debugEl = document.getElementById("debug");
  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnTorch = document.getElementById("btnTorch");
  const btnFocus = document.getElementById("btnFocus");
  const zoomEl = document.getElementById("zoom");

  function setStatus(msg, cls="") {
    statusEl.className = "small " + cls;
    statusEl.textContent = msg;
  }
  function dbg(msg) {
    debugEl.textContent = msg + "\n" + debugEl.textContent;
    console.log(msg);
  }

  // Operator yadda saxla
  operatorEl.value = localStorage.getItem("operator") || "";
  operatorEl.addEventListener("input", ()=> localStorage.setItem("operator", operatorEl.value));

  // ====== FILTER RULES ======
  // Yalnƒ±z 2026/2027/2028 il…ô ba≈ülayan v…ô yalnƒ±z r…ôq…ôml…ôr
  function isAllowedBarcode(code) {
    if (!/^\d+$/.test(code)) return false;
    return code.startsWith("2026") || code.startsWith("2027") || code.startsWith("2028");
  }

  // ====== POST (urlencoded; response text -> parse JSON attempt) ======
  async function postScan(barcode, operator) {
    const body = new URLSearchParams({ barcode, operator });

    const res = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });

    const text = await res.text();
    dbg("POST RESP (" + res.status + "): " + text.slice(0, 200));

    if (!res.ok) throw new Error("HTTP " + res.status + ": " + text);

    // Server JSON qaytarƒ±rsa oxuyaq, qaytarmƒ±rsa da OK text ola bil…ôr
    try {
      const data = JSON.parse(text);
      if (data && data.ok === false) throw new Error(data.error || "Server error");
      if (data && data.ok === true) return true;
    } catch {
      // JSON deyil ‚Üí text kimi yoxla
      if (!text.trim().toUpperCase().startsWith("OK")) {
        throw new Error(text || "Unknown server response");
      }
    }
    return true;
  }

  // ====== Torch / Zoom / Focus ======
  let track = null;
  let torchOn = false;

  async function initTrackControls() {
    try {
      const video = viewportEl.querySelector("video");
      const stream = video && video.srcObject;
      if (!stream) return;

      track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      dbg("Caps: " + JSON.stringify({
        torch: !!caps.torch,
        zoom: caps.zoom ? {min:caps.zoom.min, max:caps.zoom.max} : null,
        focusMode: caps.focusMode || null
      }));

      btnTorch.disabled = !caps.torch;

      if (caps.zoom) {
        zoomEl.disabled = false;
        zoomEl.min = caps.zoom.min;
        zoomEl.max = caps.zoom.max;
        zoomEl.step = 0.1;
        // default 2x (m√ºmk√ºns…ô)
        zoomEl.value = Math.min(Math.max(2.0, zoomEl.min), zoomEl.max);
        await setZoom(zoomEl.value);
      } else {
        zoomEl.disabled = true;
      }

      btnFocus.disabled = !(caps.focusMode && caps.focusMode.length);
    } catch (e) {
      dbg("Track init error: " + (e.message || e));
    }
  }

  async function setTorch(on) {
    if (!track?.applyConstraints) return;
    await track.applyConstraints({ advanced: [{ torch: on }] });
    torchOn = on;
    dbg("Torch: " + (on ? "ON" : "OFF"));
  }

  async function setZoom(val) {
    if (!track?.applyConstraints) return;
    await track.applyConstraints({ advanced: [{ zoom: Number(val) }] });
    dbg("Zoom set: " + val);
  }

  async function refocus() {
    if (!track?.applyConstraints) return;
    await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
    dbg("Refocus: continuous");
  }

  btnTorch.onclick = async () => { try { await setTorch(!torchOn); } catch(e){ dbg("Torch error: "+(e.message||e)); } };
  zoomEl.oninput = async () => { try { await setZoom(zoomEl.value); } catch(e){ dbg("Zoom error: "+(e.message||e)); } };
  btnFocus.onclick = async () => { try { await refocus(); } catch(e){ dbg("Focus error: "+(e.message||e)); } };

  // ====== Scanner State ======
  let running = false;

  // Eyni barkodu dalbadal yazmasƒ±n:
  let lastAccepted = "";
  let lastAcceptedAt = 0;

  // Debounce/anti-spam: eyni kodu 2 saniy…ô …ôrzind…ô yen…ô yazmasƒ±n
  const DUP_WINDOW_MS = 2000;

  function stopScanner() {
    running = false;
    try { Quagga.stop(); } catch {}
    btnStart.disabled = false;
    btnStop.style.display = "none";
    btnTorch.disabled = true;
    btnFocus.disabled = true;
    zoomEl.disabled = true;
    track = null;
    setStatus("Dayandƒ±rƒ±ldƒ±.", "");
  }

  btnStop.onclick = stopScanner;

  btnStart.onclick = async () => {
    debugEl.textContent = "";

    const operator = operatorEl.value.trim();
    if (!operator) {
      setStatus("Operatoru yaz (m…ôs: Guard-1).", "err");
      operatorEl.focus();
      return;
    }

    btnStart.disabled = true;
    btnStop.style.display = "block";
    setStatus("Kamera a√ßƒ±lƒ±r / Scanner start...", "");

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: viewportEl,
        constraints: {
          facingMode: "environment",
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        area: { // m…ôrk…ôz zonasƒ±
          top: "20%",
          right: "10%",
          left: "10%",
          bottom: "20%"
        }
      },
      locator: {
        patchSize: "large",
        halfSample: false
      },
      locate: true,
      numOfWorkers: 2,
      frequency: 10,
      decoder: {
        readers: [
          "code_39_reader",
          "code_128_reader",
          "ean_reader",
          "ean_8_reader",
          "upc_reader",
          "upc_e_reader",
          "i2of5_reader",
          "codabar_reader",
          "code_93_reader"
        ]
      }
    }, (err) => {
      if (err) {
        dbg("INIT ERROR: " + err);
        setStatus("Kamera/scanner a√ßƒ±lmadƒ± ‚ùå " + err, "err");
        btnStart.disabled = false;
        btnStop.style.display = "none";
        return;
      }

      Quagga.start();
      running = true;
      setStatus("Scan aktivdir ‚úÖ Barkodu 20-30 sm tut. Parƒ±ltƒ± varsa kaƒüƒ±zƒ± azca …ôy.", "ok");
      dbg("Quagga started ‚úÖ");

      setTimeout(initTrackControls, 800);
    });

    Quagga.onProcessed((result) => {
      if (!running) return;
      const drawingCtx = Quagga.canvas.ctx.overlay;
      const drawingCanvas = Quagga.canvas.dom.overlay;
      if (!drawingCtx || !drawingCanvas) return;

      drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

      if (result && result.boxes) {
        result.boxes.filter(b => b !== result.box).forEach((box) => {
          Quagga.ImageDebug.drawPath(box, {x:0, y:1}, drawingCtx, { color: "rgba(0,255,0,0.25)", lineWidth: 2 });
        });
      }
      if (result && result.box) {
        Quagga.ImageDebug.drawPath(result.box, {x:0, y:1}, drawingCtx, { color: "rgba(255,0,0,0.55)", lineWidth: 3 });
      }
    });

    Quagga.onDetected(async (data) => {
      if (!running) return;

      const code = (data && data.codeResult && data.codeResult.code)
        ? String(data.codeResult.code).trim()
        : "";
      if (!code) return;

      // 1) Filter: yalnƒ±z 2026/2027/2028
      if (!isAllowedBarcode(code)) {
        dbg("SKIP (not allowed): " + code);
        return;
      }

      // 2) Dalbadal eyni barkod d√º≈üm…ôsin (immediate)
      if (code === lastAccepted) {
        dbg("SKIP (same as last): " + code);
        return;
      }

      // 3) Time window: eyni kod 2 saniy…ô i√ßind…ô t…ôkrar d√º≈üm…ôsin
      const now = Date.now();
      if (code === lastAccepted && (now - lastAcceptedAt) < DUP_WINDOW_MS) {
        dbg("SKIP (dup window): " + code);
        return;
      }

      // q…ôbul edirik
      lastAccepted = code;
      lastAcceptedAt = now;

      dbg("READ ‚úÖ " + code);
      if (navigator.vibrate) navigator.vibrate(80);

      setStatus(`Oxundu: ${code} ‚Üí g√∂nd…ôrilir...`, "");
      try {
        await postScan(code, operatorEl.value.trim());
        setStatus(`Yazƒ±ldƒ± ‚úÖ ${code}`, "ok");
      } catch (e) {
        setStatus("POST X…ôta ‚ùå " + (e.message || e), "err");
        dbg("POST X∆èTASI: " + (e.message || e));
      }
    });
  };

  setStatus("Operator yaz ‚Üí Scan ba≈üla. Yalnƒ±z 2026/2027/2028 ba≈ülayanlar q…ôbul edil…ôc…ôk.", "");
</script>
</body>
</html>
